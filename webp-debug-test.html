<!DOCTYPE html>
<html>
<head>
    <title>WebP Export Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { border: 1px solid #ccc; margin: 10px 0; padding: 15px; }
        .success { color: green; } .warning { color: orange; } .error { color: red; }
        canvas { border: 1px solid black; margin: 10px; }
        button { margin: 5px; padding: 10px; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>WebP Export Debugging Tool</h1>
    <p><strong>Based on research:</strong> WebP issues are common even in professional software like <a href="https://community.adobe.com/t5/photoshop-ecosystem-discussions/webp-has-disappeared-from-export/td-p/13550219">Adobe Photoshop</a></p>
    
    <div class="test-section">
        <h2>Browser Information</h2>
        <div id="browserInfo"></div>
    </div>

    <div class="test-section">
        <h2>WebP Support Tests</h2>
        <button onclick="runAllTests()">Run All WebP Tests</button>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h2>Canvas Tests</h2>
        <button onclick="createTestCanvas()">Create Test Canvas</button>
        <button onclick="testWebPExport()">Test WebP Export</button>
        <button onclick="testJPEGExport()">Test JPEG Export</button>
        <div id="canvasArea"></div>
        <div id="exportResults"></div>
    </div>

    <script>
        // Display browser information
        document.getElementById('browserInfo').innerHTML = `
            <strong>User Agent:</strong> ${navigator.userAgent}<br>
            <strong>Browser:</strong> ${getBrowserName()}<br>
            <strong>WebP Feature Detection:</strong> ${supportsWebP()}
        `;

        function getBrowserName() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        function supportsWebP() {
            const canvas = document.createElement('canvas');
            return canvas.toDataURL('image/webp', 0.5).startsWith('data:image/webp');
        }

        async function runAllTests() {
            const results = document.getElementById('testResults');
            results.innerHTML = '<h3>Running Tests...</h3>';
            
            const tests = [
                { name: 'Basic WebP Support', test: testBasicWebP },
                { name: 'WebP with Quality', test: testWebPQuality },
                { name: 'WebP vs PNG Comparison', test: testWebPvsPNG },
                { name: 'Complex Pattern WebP', test: testComplexWebP },
                { name: 'Real Image WebP', test: testRealImageWebP }
            ];

            let html = '';
            for (const test of tests) {
                try {
                    const result = await test.test();
                    html += `<div class="result ${result.success ? 'success' : 'error'}">
                        <strong>${test.name}:</strong> ${result.message}
                        ${result.details ? `<br><small>${result.details}</small>` : ''}
                    </div>`;
                } catch (e) {
                    html += `<div class="result error">
                        <strong>${test.name}:</strong> Error - ${e.message}
                    </div>`;
                }
            }
            results.innerHTML = html;
        }

        function testBasicWebP() {
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 1;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'red';
            ctx.fillRect(0, 0, 1, 1);
            
            const webpData = canvas.toDataURL('image/webp');
            const success = webpData.startsWith('data:image/webp');
            
            return {
                success,
                message: success ? 'WebP basic support detected' : 'WebP not supported',
                details: `Data URL: ${webpData.substring(0, 50)}...`
            };
        }

        function testWebPQuality() {
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 10;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = 'blue';
            ctx.fillRect(0, 0, 10, 10);
            
            const webpLow = canvas.toDataURL('image/webp', 0.1);
            const webpHigh = canvas.toDataURL('image/webp', 0.9);
            
            const success = webpLow.startsWith('data:image/webp') && 
                          webpHigh.startsWith('data:image/webp') &&
                          webpLow !== webpHigh;
            
            return {
                success,
                message: success ? 'WebP quality control working' : 'WebP quality issues',
                details: `Low quality length: ${webpLow.length}, High quality length: ${webpHigh.length}`
            };
        }

        function testWebPvsPNG() {
            const canvas = document.createElement('canvas');
            canvas.width = canvas.height = 20;
            const ctx = canvas.getContext('2d');
            
            // Create pattern
            ctx.fillStyle = '#ff0000';
            ctx.fillRect(0, 0, 10, 10);
            ctx.fillStyle = '#00ff00';
            ctx.fillRect(10, 0, 10, 10);
            ctx.fillStyle = '#0000ff';
            ctx.fillRect(0, 10, 10, 10);
            ctx.fillStyle = '#ffff00';
            ctx.fillRect(10, 10, 10, 10);
            
            const webpData = canvas.toDataURL('image/webp', 0.8);
            const pngData = canvas.toDataURL('image/png');
            
            const success = webpData.startsWith('data:image/webp') && 
                          webpData !== pngData &&
                          webpData.length > 100;
            
            return {
                success,
                message: success ? 'WebP properly different from PNG' : 'WebP identical to PNG (not working)',
                details: `WebP: ${webpData.length} chars, PNG: ${pngData.length} chars, Different: ${webpData !== pngData}`
            };
        }

        function testComplexWebP() {
            const canvas = document.createElement('canvas');
            canvas.width = 50;
            canvas.height = 50;
            const ctx = canvas.getContext('2d');
            
            // Create complex pattern with gradients
            const gradient = ctx.createLinearGradient(0, 0, 50, 50);
            gradient.addColorStop(0, 'red');
            gradient.addColorStop(0.5, 'yellow');
            gradient.addColorStop(1, 'blue');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 50, 50);
            
            // Add some shapes
            ctx.beginPath();
            ctx.arc(25, 25, 15, 0, 2 * Math.PI);
            ctx.fillStyle = 'white';
            ctx.fill();
            
            const webpData = canvas.toDataURL('image/webp', 0.8);
            const success = webpData.startsWith('data:image/webp') && webpData.length > 200;
            
            return {
                success,
                message: success ? 'Complex WebP export working' : 'Complex WebP export failed',
                details: `Result length: ${webpData.length} characters`
            };
        }

        async function testRealImageWebP() {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                canvas.width = 100;
                canvas.height = 100;
                const ctx = canvas.getContext('2d');
                
                // Create ImageData directly
                const imageData = ctx.createImageData(100, 100);
                for (let i = 0; i < imageData.data.length; i += 4) {
                    imageData.data[i] = Math.random() * 255;     // R
                    imageData.data[i + 1] = Math.random() * 255; // G
                    imageData.data[i + 2] = Math.random() * 255; // B
                    imageData.data[i + 3] = 255;                 // A
                }
                ctx.putImageData(imageData, 0, 0);
                
                const webpData = canvas.toDataURL('image/webp', 0.8);
                const success = webpData.startsWith('data:image/webp') && webpData.length > 500;
                
                resolve({
                    success,
                    message: success ? 'Real image data WebP export working' : 'Real image WebP export failed',
                    details: `Image data result length: ${webpData.length} characters`
                });
            });
        }

        function createTestCanvas() {
            const canvasArea = document.getElementById('canvasArea');
            canvasArea.innerHTML = '';
            
            const canvas = document.createElement('canvas');
            canvas.width = 200;
            canvas.height = 100;
            canvas.id = 'testCanvas';
            
            const ctx = canvas.getContext('2d');
            
            // Create test pattern similar to what the extension might have
            ctx.fillStyle = '#ff6b6b';
            ctx.fillRect(0, 0, 100, 50);
            ctx.fillStyle = '#4ecdc4';
            ctx.fillRect(100, 0, 100, 50);
            ctx.fillStyle = '#45b7d1';
            ctx.fillRect(0, 50, 100, 50);
            ctx.fillStyle = '#f9ca24';
            ctx.fillRect(100, 50, 100, 50);
            
            // Add some text
            ctx.fillStyle = 'black';
            ctx.font = '16px Arial';
            ctx.fillText('Test Image', 75, 75);
            
            canvasArea.appendChild(canvas);
        }

        function testWebPExport() {
            const canvas = document.getElementById('testCanvas');
            if (!canvas) {
                alert('Create test canvas first!');
                return;
            }
            
            const results = document.getElementById('exportResults');
            
            try {
                const webpData = canvas.toDataURL('image/webp', 0.8);
                const success = webpData.startsWith('data:image/webp');
                
                const downloadLink = document.createElement('a');
                downloadLink.href = webpData;
                downloadLink.download = 'test-export.webp';
                downloadLink.textContent = 'Download Test WebP';
                downloadLink.style.display = 'block';
                downloadLink.style.margin = '10px 0';
                
                results.innerHTML = `
                    <div class="result ${success ? 'success' : 'error'}">
                        <strong>WebP Export Test:</strong> ${success ? 'SUCCESS' : 'FAILED'}<br>
                        Format: ${webpData.substring(0, 30)}...<br>
                        Length: ${webpData.length} characters<br>
                        ${success ? downloadLink.outerHTML : ''}
                    </div>
                `;
            } catch (e) {
                results.innerHTML = `<div class="result error">WebP Export Error: ${e.message}</div>`;
            }
        }

        function testJPEGExport() {
            const canvas = document.getElementById('testCanvas');
            if (!canvas) {
                alert('Create test canvas first!');
                return;
            }
            
            const results = document.getElementById('exportResults');
            
            try {
                const jpegData = canvas.toDataURL('image/jpeg', 0.8);
                const success = jpegData.startsWith('data:image/jpeg');
                
                const downloadLink = document.createElement('a');
                downloadLink.href = jpegData;
                downloadLink.download = 'test-export.jpg';
                downloadLink.textContent = 'Download Test JPEG';
                downloadLink.style.display = 'block';
                downloadLink.style.margin = '10px 0';
                
                results.innerHTML = `
                    <div class="result ${success ? 'success' : 'warning'}">
                        <strong>JPEG Export Test:</strong> ${success ? 'SUCCESS' : 'CHECK RESULT'}<br>
                        Format: ${jpegData.substring(0, 30)}...<br>
                        Length: ${jpegData.length} characters<br>
                        ${downloadLink.outerHTML}
                    </div>
                `;
            } catch (e) {
                results.innerHTML = `<div class="result error">JPEG Export Error: ${e.message}</div>`;
            }
        }

        // Run basic tests on page load
        window.onload = () => {
            runAllTests();
        };
    </script>
</body>
</html> 